---
- name: Install dependencies
  yum: pkg={{ item }} state=installed
  with_items:
    - yum-utils
    - device-mapper-persistent-data
    - lvm2
       
#- name: Add Docker CE repos
  #command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    
#- name: Install Docker
  #yum:
    #name: docker-ce-17.07.0.ce
    #state: present
    
# - name: Install Docker CE
  # yum:
    # name: docker-ce-17.07.0.ce
    # state: present

- name: Add Docker CE repository
  get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo
    force: yes
    owner: root
    group: root
    mode: 0644

- name: Install Docker CE
  yum:
    name: docker-ce
    state: present
    update_cache: yes

- name: Start Docker service
  service:
    name: docker
    state: started
    
- name: Stop Docker service
  service:
    name: docker
    state: stopped
    
- name: Configure direct-lvm mode
  command: "{{ item }}" 
  with_items: 
    #- sudo systemctl stop docker
    #- sudo lvremove thinpool docker -y
    #- sudo lsblk
    - sudo yum install lvm* -y
    - sudo pvcreate /dev/xvdf -ff -y
    #- sudo lsblk
    - sudo vgcreate docker /dev/xvdf
    - sudo lvcreate --wipesignatures y -n thinpool docker -l 95%VG -y
    #- sudo lsblk
    - sudo lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG
    - sudo lvconvert -y --zero n -c 512K --thinpool docker/thinpool --poolmetadata docker/thinpoolmeta
    #- sudo lsblk

- name: Configure autoextension of thin pools via LVM profile 
  copy:
    content: "activation {
                thin_pool_autoextend_threshold=80
                thin_pool_autoextend_percent=20 }"
    dest: "/etc/lvm/profile/docker-thinpool.profile"
    backup: yes
    mode: 0644
    
- name: Apply the LVM profile and enable monitoring for logical volumes
  command: "{{item}}"
  with_items:
    #- sudo cat /etc/lvm/profile/docker-thinpool.profile
    - sudo lvchange --metadataprofile docker-thinpool docker/thinpool
    - sudo lvs -o+seg_monitor
    - sudo mkdir /var/lib/docker.bk
    - sudo mv /var/lib/docker/ /var/lib/docker.bk
    
- name: Configure the options needed for the devicemapper storage driver
  copy:
    content: {"storage-driver": "devicemapper",
              "storage-opts": [
              "dm.thinpooldev=/dev/mapper/docker-thinpool",
              "dm.use_deferred_removal=true",
              "dm.use_deferred_deletion=true" ],
              "log-driver": "journald"}
    dest: "/etc/docker/daemon.json"
    backup: yes
    mode: 0644
    
- name: Start Docker service
  service:
    name: docker
    state: started
